# Vue路由原理解析

随着前端应用的业务功能越来越复杂、用户对于使用体验的要求越来越高，单页应用（SPA）成为前端应用的主流形式。大型单页应用最显著特点之一就是采用前端路由系统，通过改变URL，在不重新请求页面的情况下，更新页面视图。

## 后端路由

**路由** 这个概念最先是后端出现的。在以前用模板引擎开发页面时，经常会看到这样

```js
http://www.xxx.com/login
```

大致流程可以看成这样：

1. 浏览器发出请求
2. 服务器监听到80端口（或443）有请求过来，并解析url路径
3. 根据服务器的路由配置，返回相应信息（可以是 html 字串，也可以是 json 数据，图片等）
4. 浏览器根据数据包的 Content-Type 来决定如何解析数据
5. 简单来说路由就是用来跟后端服务器进行交互的一种方式，通过不同的路径，来请求不同的资源，请求不同的页面是路由的其中一种功能。

## 前端路由

随着 ajax 的流行，异步数据请求交互运行在不刷新浏览器的情况下进行。而异步交互体验的更高级版本就是 SPA —— 单页应用。单页应用不仅仅是在页面交互是无刷新的，连页面跳转都是无刷新的，为了实现单页应用，所以就有了前端路由。 类似于服务端路由，前端路由实现起来其实也很简单，就是匹配不同的 url 路径，进行解析，然后动态的渲染出区域 html 内容。但是这样存在一个问题，就是 url 每次变化的时候，都会造成页面的刷新。那解决问题的思路便是在改变 url 的情况下，保证页面的不刷新。

“更新视图但不重新请求页面”是前端路由原理的核心之一，目前在浏览器环境中这一功能的实现主要有两种方式：

- 利用URL中的hash（“#”）
- 利用History interface在 HTML5中新增的方法

### Hash 模式

在 2014 年之前，大家是通过 hash 来实现路由,url hash 就是类似于：

```js
http://www.xxx.com/#/login
```

这种 #。后面 hash 值的变化，并不会导致浏览器向服务器发出请求，浏览器不发出请求，也就不会刷新页面。另外每次 hash 值的变化，还会触发hashchange 这个事件，通过这个事件我们就可以知道 hash 值发生了哪些变化。然后我们便可以监听hashchange来实现更新页面部分内容的操作：

```js
function matchAndUpdate () {
   // todo 匹配 hash 做 dom 更新操作
}

window.addEventListener('hashchange', matchAndUpdate)
```

### History 模式

14年后，因为HTML5标准发布。多了两个 API，pushState 和 replaceState，通过这两个 API 可以改变 url 地址且不会发送请求。同时还有popstate 事件。通过这些就能用另一种方式来实现前端路由了，但原理都是跟 hash 实现相同的。用了 HTML5 的实现，单页路由的 url 就不会多出一个#，变得更加美观。但因为没有 # 号，所以当用户刷新页面之类的操作时，浏览器还是会给服务器发送请求。为了避免出现这种情况，所以这个实现需要服务器的支持，需要把所有路由都重定向到根页面。

```js
function matchAndUpdate () {
   // todo 匹配路径 做 dom 更新操作
}

window.addEventListener('popstate', matchAndUpdate)
```

## 路由实现原理

在HTML5的 history API 出现之前，前端的路由都是通过 hash 来实现的，hash 能兼容低版本的浏览器。当 url 的 hash 发生变化时，触发 hashchange 注册的回调，回调中去进行不同的操作，进行不同的内容的展示。

## Hash路由

html:

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>
<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="#/">首页</a></li>
                <li><a href="#/new">新闻</a></li>
                <li><a href="#/product">产品</a></li>
                <li><a href="#/about">关于我们</a></li>
            </ul>

        </nav>
    </div>

    <div id="content">

    </div>
    <script>
    var content = document.querySelector('#content')
    var r = Router({
        '/':function(){
            content.innerHTML = "首页"
        },
        '/new':function(){
            content.innerHTML = "新闻"
        },
        '/product':function(){
            content.innerHTML = "产品"
        },
        '/about':function(){
            content.innerHTML = "关于我们"
        },
    })
    </script>
</body>
</html>
```

js:

```js
function _route(option){
    this.option = option || {};
}
_route.prototype.on = function(ev,callback){
    var evs = ev.split(" ");
    for(var i=0;i<evs.length;i++){
        window.addEventListener(evs[i],callback)
    }
}

_route.prototype.init = function(){
    this.on("load hashchange",this.refresh.bind(this))
}

_route.prototype.refresh = function(){
    this.currentUrl = location.hash.slice(1)||"/";
    this.option[this.currentUrl]();
}

_route.prototype.rt = function(path,callback){
    this.option[path] = callback;
    return this;
}

function Router(option){
    var r = new _route(option);
    r.init();
    return r;
}
```

## HTML5 history API路由实现

html5 增加了两个方法，分别是`pushState`，`replaceState`。

`pushState`和`replaceState`是用来手动插入历史记录，然后执行AJAX请求，而popstate就是当浏览器前进后退的时候获得相应的state再执行相应操作。

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>History Roter</title>
</head>
<body>
    <div class="container">
        <nav>
            <ul>
                <li><a href="#/">首页</a></li>
                <li><a href="#/new">新闻</a></li>
                <li><a href="#/product">产品</a></li>
                <li><a href="#/about">关于我们</a></li>
            </ul>
        </nav>
    </div>

    <div id="content"></div>
    <script>
    class Router {
         constructor(routes = {}) {
              this.routes = routes;
              this.curUrl = "";
          }
          notify(state){
            this.curUrl = state.path || '/';
            if(this.routes[this.curUrl]){
              this.routes[this.curUrl]();
            }else{
              console.log('路由没有注册');
            }
          }
          route(path,callback){
            this.routes[path] = callback || function(){

            }
          }
          init(){
            let that = this;
            //浏览器点击前进后退时触发的事件
             window.addEventListener('popstate',function(event){
                that.notify(event.state || {})
             }, false);

             //监控页面A标签，跳转做处理
             document.querySelector('body').addEventListener('click', function(event){
              if(event.target.tagName === 'A'){
                let link = event.target.getAttribute('href');
                if(!/^http/.test(link)){
                  event.preventDefault();
                  let path = link.slice(1) || '/';
                  that.notify({ 'path' : path} || {})
                  if(event.target.getAttribute('type') == 'replace'){
                    history.replaceState({ 'path' : path},'',event.target.href);
                  }else{
                    history.pushState({ 'path' : path},'',event.target.href);
                  }             
                }       
              }   
             }, false)

             //首次进入页面进行路由
            let path = location.hash.slice(1) || '/';
            that.notify({ 'path' : path} || {})
          }
      }

      function changeContent(text){
        document.getElementById('content').innerHTML = text;
      }
      let router = new Router({
        '/':function(){
            changeContent('首页');
            },
            '/new':function(){
            changeContent('新闻');
            },
            '/product':function(){
          changeContent('产品');
            }
      })

      router.route('/about',function(){
        changeContent('关于我们');
      })

      router.init();
    </script>
</body>

</html>
```

## Vue router 实现

我们来看一下vue-router是如何定义的：

```js
import VueRouter from 'vue-router'
Vue.use(VueRouter)

const router = new VueRouter({
  mode: 'history',
  routes: [...]
})

new Vue({
  router
  ...
})
```
