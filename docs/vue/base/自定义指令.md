# 自定义指令

除了默认设置的核心指令,Vue 也允许注册自定义指令。 Vue自定义指令默认以 `v-` 开头

## 自定义指令与使用

首先创建一个单纯的全局指令（它还没有做任何事情）。

```js
vue.directive('tack');
```

根据这个指令HTML就是这样的：

```js
<p v-tack>This element has a directive on it</p>
```

## 自定义指令类型

Vue自定义指令可以分为两种：

- 全局指令
- 局部指令

### 注册全局指令

需要注意的是全局注册自定义指令需在实例化Vue之前：

```js
Vue.directive( id, [definition] )
```

参数：

- {string} id 指令名称
- {Function | Object} [definition] 指令参数

```js
// 注册
Vue.directive('my-directive', {
  bind: function () {},
  inserted: function () {},
  update: function () {},
  componentUpdated: function () {},
  unbind: function () {}
})

// 注册 (指令函数)
Vue.directive('my-directive', function () {
  // 这里将会被 `bind` 和 `update` 调用
})

// getter，返回已注册的指令
var myDirective = Vue.directive('my-directive')
```

例如，注册注册一个指令，使一个 input 元素自动获得焦点：

```js
// 注册一个全局自定义指令 v-focus
Vue.directive('focus', {
  // inserted指令钩子函数:当绑定元素插入到 DOM 中时。
  inserted: function (el) {
    // 聚焦元素
    el.focus()
  }
})
```

### 注册局部指令

注册局部指令，组件中接受一个 directives 的选项：

```js
export default{
     directives:{
        '指令名称':'指令配置'
        id: [definition]
     },
}
```

参数：

- {string} id 指令名称
- {Function | Object} [definition] 指令参数

```js
new Vue({
    directives: {
        focus: {
            // 指令的定义
            inserted: function (el) {
              el.focus()
            }
        }
    }
})
```

然后你可以在模板中任何元素上使用新的 v-focus 属性：

```html
<input v-focus>
```

## 自定义指令的钩子函数

对于自定义指令的定义，Vue2 有 5 个可选的钩子函数。 (钩子函数即vue的内置事件，见 “计算属性——生命周期与钩子函数”)

| 函数名           | 描述                                                         |
| ---------------- | ------------------------------------------------------------ |
| bind             | 只调用一次，指令第一次绑定到元素时调用，用这个钩子函数可以定义一个在绑定时执行一次的初始化动作。 |
| inserted         | 被绑定元素插入父节点时调用（父节点存在即可调用，不必存在于 document 中）。 |
| update           | 被绑定元素所在的模板更新时调用，而不论绑定值是否变化。       |
| componentUpdated | 被绑定元素所在模板完成一次更新周期时调用。                   |
| unbind           | 只调用一次，指令与元素解绑时调用。                           |

![img](/blog/img/vue/vue-cutom-directive.svg)

钩子函数被赋予了以下参数：

| 参数     | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| el       | 指令所绑定的元素，可以用来直接操作 DOM 。                    |
| binding  | 一个对象，包含以下属性：                                     |
|          | **name**: 指令名，不包括 v- 前缀。                           |
|          | **value**: 指令的绑定值， 例如： v-my-directive="1 + 1", value 的值是 2。 |
|          | **oldValue**: 指令绑定的前一个值，仅在 update 和 componentUpdated 钩子中可用。无论值是否改变都可用。 |
|          | **expression**: 绑定值的字符串形式。 例如 v-my-directive="1 + 1" ， expression 的值是 "1 + 1"。 |
|          | **arg**: 传给指令的参数。例如 v-my-directive:foo， arg 的值是 "foo"。 |
|          | **modifiers**: 一个包含修饰符的对象。 例如： v-my-directive.foo.bar, 修饰符对象 modifiers 的值是 { foo: true, bar: true }。 |
| vnode    | Vue 编译生成的虚拟节点。移步 VNode API 来了解更多详情。      |
| oldVnode | 上一个虚拟节点，仅在 update 和 componentUpdated 钩子中可用。 |

> 注意：除了el之外，其它参数都应该是只读的，切勿进行修改。如果需要在钩子之间共享数据，建议通过元素的 dataset 来进行。

```js
new Vue({
    directives: {
        focus: {
            // 指令的定义
            bind: function (el,binding) {},
            inserted: function (el,binding) {},
            update: function (el,binding) {},
            componentUpdated: function (el,binding) {},
            unbind: function (el,binding) {}
        }
    }
})
```

## 函数简写

在很多时候，你可能想在 bind 和 update 时触发相同行为，而不关心其它的钩子。比如这样写:

```js
Vue.directive('color-swatch', function (el, binding) {
  el.style.backgroundColor = binding.value
})
```

## 自定义插件案例

### 图片加载

图片在加载过程中,未加载完成时,使用一个颜色占位,图片加载完后直接显示,可以使用自定义指令来完成。

```html
HTML -----------------------------------
<div id="demo">
    <div v-img="v" v-for="v in imgs" class="img"></div>
</div>

CSS -----------------------------------
<style>
.img{
    width: 300px;
    height: 240px;
    margin: 10px;
    background-size: cover;
    float: left;
}
</style>

JS -----------------------------------
<script>
Vue.directive('img', {
  // inserted指令钩子函数:当绑定元素插入到 DOM 中时。
  inserted: function (el,binding) {
    var bgColor = "#eee";
    el.style.backgroundColor = bgColor;

    var img = new Image();
    img.src = binding.value;
    img.onload = function(){
        el.style.backgroundImage = 'url('+binding.value+')'
    }
  }
})
new Vue({
    el:'#demo',
    data:{
        imgs:[
            "https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1513444087063&di=114ff2141785aae38f0e4ff9581da4e7&imgtype=0&src=http%3A%2F%2Fimgsrc.baidu.com%2Fimgad%2Fpic%2Fitem%2F9825bc315c6034a81c94dd93c1134954092376a9.jpg",
            "https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1513444105388&di=0bfb5c5108532ac51103a2b02baff90c&imgtype=0&src=http%3A%2F%2Fdl.bizhi.sogou.com%2Fimages%2F2013%2F08%2F20%2F360548.jpg",
            "https://timgsa.baidu.com/timg?image&quality=80&size=b10000_10000&sec=1513434040&di=06b77302cbb74f54fc1a7e2a1ff8baf3&src=http://www.bz55.com/uploads/allimg/150316/140-150316105543.jpg"
        ]
    }
})
</script>
```

效果如下：

![img](/blog/img/vue/lazyload.gif)

### 代码高亮插件

```HTML
<link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/default.min.css" rel="stylesheet">
<script src="http://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

<pre id="demo" >
    <code v-code class="html">{{codes}}</code>
</pre>


JS
<script>
Vue.directive('code', {
  // inserted指令钩子函数:当绑定元素插入到 DOM 中时。
  inserted: function (el) {
      console.log(hljs);
      hljs.highlightBlock(el);
  }
})
new Vue({
    el:"#demo",
    data:{
        codes:"<div class='content'>\n\t<h2>Vue是一个渐进式的库！</h2>\n\t<p>hello Vue!</p>\n</div>"
    }
})
</script>
```

效果如下：

![img](/blog/img/vue/highlight.png)

### 拖拽效果

```html
HTML:
<div v-drag>我可以拖拽</div>

js:
<script>
export default

Vue.directive('drag',function(el){
    let oDiv=el;
    oDiv.onmousedown=function(e){
        let l=e.clientX-oDiv.offsetLeft;
        let t=e.clientY-oDiv.offsetTop;
        document.onmousemove=function(e){
            oDiv.style.left=e.clientX-l+'px';
            oDiv.style.top=e.clientY-t+'px';
        };
        oDiv.onmouseup=function(){
            document.onmousemove=null;
            oDiv.onmouseup=null;
        }
    }
})
</script>
```
