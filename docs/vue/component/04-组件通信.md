# 组件通信

> 界面通过组件组合构成，这就意味着组件间需要进行通信。

在 Vue 中，父子组件的关系可以总结为 prop 向下传递，事件向上传递。

1. 父组件通过 prop 给子组件下发数据。
2. 子组件通过事件给父组件发送消息。

看看它们是怎么工作的。

![img](/blog/img/vue/usedata.png)

## 父组件向子组件传递数据

> 父组件通过 prop 给子组件下发数据

### 基本使用

```js
<div id="app">
    <!-- 可以向它传入一个普通字符串 -->
    <mytitle title="hello Vue!!"></mytitle>
</div>
Vue.component('mytitle',{
    // 声明 props
    props:['title'],
    template:"<h1>{{title}}</h1>"
})
new Vue({
    el:"#app"
})
```

### Prop命名 camelCase vs. kebab-case

HTML 特性是不区分大小写的。所以，当使用的不是字符串模板时，camelCase (驼峰式命名) 的 prop 需要转换为相对应的 kebab-case (短横线分隔式命名)：

```js
Vue.component('child', {
  // 在 JavaScript 中使用 camelCase
  props: ['myMessage'],
  template: '<span>{{ myMessage }}</span>'
})
<!-- 在 HTML 中使用 kebab-case -->
<child my-message="hello!"></child>
```

如果你使用字符串模板，则没有这些限制。

### 动态 Prop

与绑定到任何普通的 HTML 特性相类似，我们可以用 v-bind 来动态地将 prop 绑定到父组件的数据。每当父组件的数据变化时，该变化也会传导给子组件：

```html
<div id="app">
    <input type="text" v-model="msg">
    <texts v-bind:content="msg"></texts>
    <texts :content="msg"></texts>
</div>
<script>
Vue.component('texts',{
    props:['content'],
    template:"<p>{{content}}</p>"
})
new Vue({
    el:"#app",
    data:{
        msg:"hello!!"
    }
})
</script>
```

如果你想把一个对象的所有属性作为 prop 进行传递，可以使用不带任何参数的 v-bind (即用 v-bind 而不是 v-bind:prop-name)。例如，已知一个 person 对象：

```js
<div id="app">
    <person v-bind="persons"></person>
</div>
<template id="person">
    <div>
        <span>姓名：{{name}}</span>
        <span>年龄：{{age}}</span>
    </div>
</template>
Vue.component('person',{
    props:['name','age'],
    template:"#person"
})
new Vue({
    el:"#app",
    data:{
        persons:{id:1,name:"张三",age:19}
    }
})
```

### 单向数据流

Prop 是单向绑定的：

1. 当父组件的属性变化时，将传导给子组件，但是反过来不会。
2. 每次父组件更新时，子组件的所有 prop 都会更新为最新值。
3. 不能在子组件内部改变 prop。

在两种情况下，我们很容易忍不住想去修改 prop 中数据：

- Prop 作为初始值传入后，子组件想把它当作局部数据来用；

```html
<div id="app">
    <counter :init-count="num"/>

</div>
<template id="person">
    <button @click="count++">{{count}}</button>
</template>
<script>
Vue.component('counter',{
    props:['initCount'],
    template:"#person",
    data:function(){
        return {count:this.initCount}
    }
})
new Vue({
    el:"#app",
    data:{
        num:10
    }
})
</script>
```

- Prop 作为原始数据传入，由子组件处理成其它数据输出。

```html
<div id="app">
    <timer :init-time="t1"></timer>
    <timer :init-time="t2"></timer>
</div>
<template id="timer">
    <div>{{normalizedTime}}</div>
</template>
<script>
Vue.component('timer',{
    props:['initTime'],
    template:"#timer",
    computed:{
        normalizedTime:function(){
            var d = new Date(this.initTime);
            var y = d.getFullYear();
            var m = d.getMonth()+1;
            var date = d.getDate();
            return y+'-'+m+'-'+date;
        }
    }
})
new Vue({
    el:"#app",
    data:{
        t1:new Date(),
        t2:(+new Date())
    }
})
</script>
```

### Prop 验证

我们可以为组件的 prop 指定验证规则。如果传入的数据不符合要求，Vue 会发出警告。这对于开发给他人使用的组件非常有用。

要指定验证规则，需要用对象的形式来定义 prop，而不能用字符串数组：

```js
Vue.component('example', {
  props: {
    // 基础类型检测 (`null` 指允许任何类型)
    propA: Number,
    // 可能是多种类型
    propB: [String, Number],
    // 必传且是字符串
    propC: {
      type: String,
      required: true
    },
    // 数值且有默认值
    propD: {
      type: Number,
      default: 100
    },
    // 数组/对象的默认值应当由一个工厂函数返回
    propE: {
      type: Object,
      default: function () {
        return { message: 'hello' }
      }
    },
    // 自定义验证函数
    propF: {
      validator: function (value) {
        return value > 10
      }
    },
    propG: {
      validator: function (value) {
        // 这个值必须匹配下列字符串中的一个
        return ['success', 'warning', 'danger'].indexOf(value) !== -1
      }
    }
  }
})
```

当 prop 验证失败的时候，(开发环境构建版本的) Vue 将会产生一个控制台的警告。

除了验证数据类型，props还可设置验证以下属性：

| 属性      | 值         | 说明                                                  |
| --------- | ---------- | ----------------------------------------------------- |
| type      | 原生构造器 | 参数的类型                                            |
| default   | any        | 参数的默认值，数组/对象的默认值应当由一个工厂函数返回 |
| required  | true/false | 参数是否必传                                          |
| validator | function   | 自定义验证函数                                        |

type 可以是下面原生构造器：

String、Number、Boolean、Function、Object、Array、Symbol、Promise

`type` 还可以是一个自定义的构造函数，并且通过 `instanceof` 来进行检查确认。例如，给定下列现成的构造函数：

```js
function Person (firstName, lastName) {
  this.firstName = firstName
  this.lastName = lastName
}
```

你可以使用：

```js
Vue.component('blog-post', {
  props: {
    author: Person
  }
})
```

来验证 `author prop` 的值是否是通过 `new Person` 创建的。

## 子组件向父组件传递数据

> 子组件通过事件给父组件发送消息

我们知道，父组件使用 prop 传递数据给子组件。但子组件怎么跟父组件通信呢？这个时候 Vue 的自定义事件系统就派得上用场了。

每个 Vue 实例都实现了事件接口，即：

- 使用 $on(eventName) 监听事件
- 使用 $emit(eventName, optionalPayload) 触发事件

```html
<div id="app">
    <p>父级total:{{total}}</p>
    <hr>
    <count v-on:increments="incrementTotal"></count>
</div>
<template id="counter">
    <div>
        <button @click="increment">子级：{{counter}}</button>
    </div>
</template>
<script>
Vue.component('count',{
    "template":"#counter",
    "data":function(){
        return {counter:0}
    },
    "methods":{
        increment:function(){
            this.counter += 1;
            this.$emit("increments")
        }
    }
})
new Vue({
    'el':"#app",
    "data":{
        total:0
    },
    "methods":{
        'incrementTotal':function(){
            this.total+=2;
        }
    }
})
</script>
```

案例：留言板

```html
<div id="app">
    <message-box></message-box>
</div>
<template id="message-box">
    <div class="message-box">
        <message-list :messages="messages"></message-list>
        <message-form v-on:submitmessage="submitMessage"></message-form>
    </div>
</template>
<template id="message-list">
    <div>
        <message-item v-bind="v" v-for="v in messages"></message-item>
    </div>
</template>
<template id="message-item">
    <div>
        <span>{{name}}</span>
        <div>
            {{msg}}
        </div>
    </div>
</template>
<template id="message-form">
    <div>
        <div>
            <span>姓名</span>
            <input type="text" v-model="name">
        </div>
        <div>
            <span>留言</span>
            <textarea v-model="msg" cols="30" rows="10"></textarea>
        </div>
        <div>
            <button @click="submit">提交</button>
        </div>
    </div>

</template>
<script>
Vue.component('messageBox',{
    template:"#message-box",
    data:function(){
        return {messages:[{name:'李四',msg:"顶楼上！！"}]}
    },
    components:{
        messageList:{
            template:"#message-list",
            props:['messages'],
            components:{
                messageItem:{
                    template:"#message-item",
                    props:['name','msg']
                }
            }
        },
        messageForm:{
            template:"#message-form",
            data:function(){
                return {
                    name:'',
                    msg:""
                }
            },
            methods:{
                submit:function(){
                    var data = {};
                    data.name = this.name;
                    data.msg = this.msg;
                    this.name="";
                    this.msg="";
                    this.$emit('submitmessage',data);
                }
            }
        }
    },
    methods:{
        submitMessage:function(data){
            this.messages.push(data)
        }
    }
})
new Vue({
    el:"#app"
})
</script>
```
