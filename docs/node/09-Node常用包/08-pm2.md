# PM2

> PM2是 Node.js 下的生产环境进程管理工具。


![pm2 logo](/blog/img/node/pm2-v4.png) 


[![npm version](https://badge.fury.io/js/pm2.svg) ](https://badge.fury.io/js/pm2)[![NPM Downloads](https://img.shields.io/npm/dm/pm2.svg?style=flat-square) ](https://www.npmjs.com/package/pm2)[![Build Status](https://travis-ci.org/Unitech/pm2.svg?branch=master) ](https://travis-ci.org/Unitech/pm2)



当我们的项目要部署到线上服务器时，不能单纯的靠 `node index` 来启动应用程序了，因为我们断掉 SSH 连接后服务就终止了，这时我们就需要像 pm2 或者 forever 这样的进程管理工具了。

PM2是 Node.js 下的生产环境进程管理工具，可以利用它来简化很多node应用管理的繁琐任务，如性能监控、自动重启、负载均衡、日志记录、错误预警等等等，而且使用非常简单。

## 为什么要使用PM2

最根本的原因是因为node本身是一个单线程，在这种模式下，一个线程只能处理一个任务，要想提高吞吐量必须通过多线程。虽然单线程的好处有很多比如避免了线程同步或者死锁、状态同步等等之类的问题，但是在应用和计算能力要求日益倍增的今天，单线程最大的弊端就是无法利用多核CPU带来的优势来提升运行效率。

1. PM2可以把你的应用部署到服务器所有的CPU上，有效的解决了无法利用多核CPU的问题。
2. PM2有完善的辅助系统性能监控、自动重启、负载均衡、日志记录、错误预警等。

## PM2主要特点

- 内建负载均衡（使用Node cluster 集群模块、子进程，可以参考朴灵的《深入浅出node.js》一书第九章）
- 线程守护，keep alive
- 0秒停机重载，维护升级的时候不需要停机.
- 现在 Linux (stable) & MacOSx (stable) & Windows (stable).多平台支持
- 停止不稳定的进程（避免无限循环）
- 控制台检测
- 提供 HTTP API
- 远程控制和实时的接口API ( Nodejs 模块,允许和PM2进程管理器交互 )

## 网址与文档

| 名称     | 地址                                                |
| -------- | --------------------------------------------------- |
| 官网     | <http://pm2.keymetrics.io/>                         |
| 英文文档 | <http://pm2.keymetrics.io/docs/usage/cluster-mode/> |

## 开始使用PM2

### 安装pm2

```
npm install pm2 -g
```

### 简单使用

```
pm2 start ./bin/www --watch
```

> 注意：这里用了--watch参数，意味着当你的express应用代码发生变化时，pm2会帮你重启服务，多贴心。

使用package.json 简化命令，修改 package.json，添加 start 的命令：

```
"scripts": {
  "start": "NODE_ENV=production pm2 start index.js --name 'myblog'"
}
```

## pm2 常用命令

### 启动

| 参数           | 说明                                                         |
| -------------- | :----------------------------------------------------------- |
| --watch        | 监听应用目录的变化，一旦发生变化，自动重启。如果要精确监听、不见听的目录，最好通过配置文件。 |
| -i --instances | 启用多少个实例，可用于负载均衡。如果-i 0或者-i max，则根据当前机器核数确定实例数目。 |
| --ignore-watch | 排除监听的目录/文件，可以是特定的文件名，也可以是正则。比如`--ignore-watch="test node_modules "some scripts""` |
| -n --name      | 应用的名称。查看应用信息的时候可以用到。                     |
| -o --output    | 标准输出日志文件的路径。                                     |
| -e --error     | 错误输出日志文件的路径。                                     |
| --interpreter  | the interpreter pm2 should use for executing app (bash, python...)。比如你用的coffee script来编写应用。 |

```
$ pm2 start app.js
$ pm2 start app.js -i max    # 根据有效CPU数目启动最大进程数目
$ pm2 start app.js -i 3      # 启动3个进程
$ pm2 start app.js -x        #用fork模式启动 app.js 而不是使用 cluster
$ pm2 start app.js -x -- -a 23       # 用fork模式启动 app.js 并且传递参数 (-a 23)
$ pm2 start app.js --name serverone  # 启动一个进程并把它命名为 serverone
$ pm2 stop serverone         # 停止 serverone 进程
$ pm2 start app.json         # 启动进程, 在 app.json里设置选项
$ pm2 start app.js -i max -- -a 23   #在--之后给 app.js 传递参数
$ pm2 start app.js -i max -e err.log -o out.log  # 启动 并 生成一个配置文件

你也可以执行用其他语言编写的app  ( fork 模式):
$ pm2 start my-bash-script.sh -x --interpreter bash
$ pm2 start my-python-script.py -x --interpreter python
```

### 停止进程

```
$ pm2 stop 0             # 停止指定的进程
$ pm2 stop all           # 停止所有进程
```

### 杀死进程

```
$ pm2 delete 0           # 杀死指定的进程
$ pm2 delete all         # 杀死全部进程
```

### 显示进程状态

```
$ pm2 ls                 # 显示所有进程状态
$ pm2 l                  # 显示所有进程状态
$ pm2 list               # 显示所有进程状态
```

### 监视所有进程

```
$ pm2 monit              # 监视所有进程
```

### 显示所有进程日志

```
$ pm2 logs               # 显示所有进程日志
$ pm2 logs [id|name]     # 查看指定进程或名称日志
```

### 重启程序

```
$ pm2 restart all        # 重启所有进程
$ pm2 restart 0          # 重启指定的进程
$ pm2 reload all         # 0秒停机重载进程 (用于 NETWORKED 进程)
```

> 更多命令请使用 pm2 -h 查看。

## 参考

| 网址                                                        |
| :---------------------------------------------------------- |
| <http://blog.csdn.net/qq_17475155/article/details/53823862> |
| <https://www.cnblogs.com/chyingp/p/pm2-documentation.html>  |
